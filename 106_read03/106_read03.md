### Read-03

#### 中断和异常处理

#### 1. 中断和异常处理概述

**中断和异常:**

​		中断是中断处理器正常程序流的事件。这些事件可以由硬件设备(如键盘或磁盘驱动器)或软件(如操作系统或设备驱动程序)生成。中断用于处理异步事件，这意味着独立于程序执行流而发生的事件。

​		异常是在指令执行期间发生的事件，导致处理器暂时停止执行当前程序。异常可以由各种情况产生，例如算术错误、内存访问违规或在用户模式下执行的特权指令。

 		当发生中断或异常时，处理器切换到称为中断或异常处理程序的不同代码路径。处理程序执行特定的任务来处理中断或异常。例如，键盘的中断处理程序可以读取被按下的键，并将其放在缓冲区中供程序稍后处理。内存访问冲突的异常处理程序可能会终止程序或显示错误消息。

 **处理器的作用:**

当中断或异常发生时，处理器执行以下步骤:

​	1. 它保存当前的处理器状态，包括寄存器和标志的值。

​	2. 它识别中断或异常类型，并从处理程序表中选择适当的处理程序。

​	3. 它将控制转移到选定的处理程序，该处理程序执行必要的操作来处理中断或异常。

​	4. 处理程序完成其任务后，将恢复步骤1中保存的处理器状态。

​	5. 处理器从被中断的地方恢复执行被中断的程序。

#### 2. 有关中断和异常了解性的内容

**中断和异常向量:**

​		这些是处理器查找与特定中断或异常相关的代码的内存位置。

**中断源和异常源:**

​		中断源是向处理器发送信号以启动中断的外部设备或计时器。异常源是在处理器中导致异常的内部事件，例如除零错误或页面错误。

**异常的分类:**

​		异常分为失败、trap和中止三类。失败异常表示程序无法处理的错误，陷阱异常用于修改程序的行为，而中止异常表示程序或任务无法完成。

 **程序或任务的重新执行:**

​		当出现异常时，处理器保存程序或任务的当前状态，并将控制权转移给中断或异常处理程序。在处理程序完成它的执行后，处理器从它停止的地方恢复程序或任务。

**启用和禁用中断:**

​		中断可以使用处理器状态寄存器(PSR)中的中断标志(IF)来启用和禁用。禁用中断可以防止不需要的中断干扰代码的关键部分。

**异常和中断的优先级:**

​		中断和异常根据它们的相关性和重要性进行优先级排序。高优先级中断可以覆盖低优先级中断，并且一些异常可以延迟到高优先级中断被处理之后。

#### 3. 中断描述符表

**中断描述表(IDT)的构造:**

​		IDT是一种数据结构，它将中断和异常向量映射到相应的中断和异常处理程序。它是一个8字节条目的表，每个条目代表一个中断或异常向量。IDT通常位于内存中，由操作系统或引导加载程序初始化。

* IDT中的每个条目包含以下字段:
  * 一个16位段选择器，指向处理程序所在的代码段。
  * 一个32位偏移量，指向处理程序的入口点，这是当中断或异常发生时要执行的第一个指令。
  * 一组标志，用于指定中断或异常处理程序的各种属性，例如它是中断还是异常，是用于用户模式还是系统模式，以及在调用一次后是否应该自动禁用它。

​		为了构造IDT，操作系统或引导加载程序通常会创建一个IDT项数组，并为每个项填充必要的字段。然后将IDT加载到内存中，其基址存储在一个称为中断描述符表寄存器(IDTR)的特殊寄存器中。

**获取中断处理程序的地址:**

​		要获得中断或异常处理程序的地址，需要构造一个指向IDT中相应项的指针。指针由两部分组成:段选择器和偏移量。要构造指针，首先要从全局描述符表(GDT)或本地描述符表(LDT)中的适当条目加载段选择器。段选择器标识处理程序所在的代码段。GDT和LDT是处理器用来存储内存段信息的数据结构。

 		一旦有了段选择器，就可以将它与相应IDT项的偏移量结合起来，形成指针。偏移量是代码段内处理程序入口点的32位地址。结果指针是中断或异常处理程序的地址。

**设置中断描述表寄存器(IDTR):**

​		要设置IDTR，需要构造一个称为IDT描述符的特殊数据结构。IDT描述符包含IDT的基址、大小和其他属性。

* 要构造IDT描述符，需要创建一个包含以下字段的结构:
  * 一个16位的字段，以字节为单位指定IDT的大小。
  * 一个32位的字段，指定IDT的基址。
  * 必要时填充字节，以确保IDT描述符有6个字节长。

​		一旦构造了IDT描述符，就可以使用LIDT指令将其地址加载到IDTR中。当中断或异常发生时，处理器使用IDTR来定位IDT。

#### 4. IDT 描述符

**中断门:**

​		中断门是一个用来处理中断的描述符。它指定了中断处理程序的段选择器和偏移量，以及各种属性。这些属性指定门是否存在、它的特权级别、它是中断还是陷阱，以及在调用一次后是否应该自动禁用它。

​		中断处理程序在一个新的堆栈中执行，处理器在调用中断处理程序之前自动将当前处理器状态(包括指令指针和标志)保存到堆栈中。一旦中断处理程序完成，处理器从堆栈中恢复保存的状态，并继续执行被中断的程序。

**陷阱门:**

​		陷阱门类似于中断门，但它用于处理异常而不是中断。像中断门一样，它指定段选择器和处理程序的偏移量，以及各种属性。这些属性指定门是否存在、它的特权级别，以及在调用一次后是否应该自动禁用它。

​		与中断门不同，陷阱门在调用处理程序时不会自动将处理器状态保存到新的堆栈中。相反，处理程序必须根据需要手动保存和恢复处理程序状态。这允许处理程序修改处理器状态并在不恢复原始状态的情况下继续执行被中断的程序。

**任务门:**

​		任务门是一个描述符，用于在多任务系统中的任务之间切换。它指定段选择器和任务状态段(TSS)的偏移量，以及各种属性。这些属性指定门是否存在、它的特权级别，以及在调用一次后是否应该自动禁用它。

​		当一个任务门被调用时，处理器将当前的处理器状态(包括指令指针和标志)保存到当前任务的堆栈中，并加载新的TSS。然后处理器从TSS加载新任务的段寄存器和指令指针，并继续执行新任务。当新任务完成时，处理器将其状态保存到堆栈中并返回到前一个任务。

#### 5. 中断与异常处理

* **中断过程调用的过程是什么?**

​		当在过程调用期间发生中断时，处理器将当前处理器状态保存到堆栈中，并加载由中断描述符表指定的中断处理程序。然后，中断处理程序使用一个新的堆栈执行，并根据需要将处理器状态保存到新的堆栈中。一旦中断处理程序完成，处理器从堆栈中恢复保存的状态，并继续执行被中断的程序。

* **如何确定中断处理和中断任务的优先级?**

​		中断处理的优先级由基于中断类型的中断向量数决定。被中断任务的优先级由其特权级别和中断控制器设置的中断优先级(IPL)决定。

+ **对于不同的优先级是否采用相同的处理方式?**

​		不，处理器根据中断的优先级不同来处理中断。高优先级中断可以中断低优先级中断，处理器将在完成当前中断后继续处理高优先级中断。

+ **如果发生堆栈交换，处理器会怎么做?**

​		如果在中断处理或任务切换期间发生堆栈切换，处理器将当前堆栈指针保存到当前任务的堆栈中，并从新任务的TSS中加载新的堆栈指针。然后处理器使用新的堆栈继续执行。

+ **如果没有发生堆栈交换，处理器会怎么做?**

​		如果在中断处理或任务切换期间没有发生堆栈切换，处理器将继续使用当前堆栈指针，而不会切换到新堆栈。如果当前堆栈不足以容纳保存的处理器状态和中断处理程序或任务的新状态，则可能导致堆栈溢出。

+ **中断进程后，如何返回，处理器做了什么?**

​		在中断进程之后，处理器通过从堆栈中加载保存的处理器状态返回到被中断的进程。中断处理程序在执行之前将被中断进程的状态保存到堆栈中，一旦中断处理程序完成，这个保存的状态用于恢复被中断的进程。

+ **异常保护和中断处理:**

​		为了防止对异常和中断处理程序的未经授权的访问，处理器提供了诸如特权级别、描述符表和段寄存器等保护机制。这些机制允许操作系统控制对中断和异常处理程序的访问，并防止对中断描述符表进行未经授权的修改。

+ **如何将标志用于异常和中断处理:**

​		标志用于指示处理器的状态，可以由中断或异常处理程序修改。处理器提供了一组可以被程序读取和修改的标志，包括进位、零、符号和溢出标志。这些标志用于确定算术和逻辑运算的结果，也用于控制程序流。

+ **中断门和陷波门的唯一区别是什么?**

​		中断门和陷阱门之间的唯一区别是它们处理中断的方式。中断门在中断被处理时清除中断标志，这可以防止其他中断中断当前的中断处理程序。当中断被处理时，陷阱门不清除中断标志，这允许其他中断中断当前的中断处理程序。 





