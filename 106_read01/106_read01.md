### Intel® 64 and IA-32 Architectures Software Developer’s Manual Note 1

#### x86系统架构概览

##### 1. 系统级体系结构概览

​	Intel®64和IA-32架构软件开发人员手册的第2章涵盖了与处理器内存架构相关的各种主题，包括全局和本地描述符表、系统段、段描述符、门、任务状态段、任务门、中断和异常处理、内存管理和系统寄存器。

+ 1.1 全局描述符表和本地描述符表: 
  + 全局描述符表(GDT)是一个系统范围的表，它包含定义操作系统使用的内存段的段描述符。GDT包括代码段、数据段和系统段的描述符，如中断描述符表和任务状态段描述符。本地描述符表(LDT)是一个每个进程的表，它包含特定进程使用的段的描述符。

* 1.2 系统段、段描述符和门:
  * 系统段是处理器用于特定目的的特殊内存段，例如存储中断描述符表(IDT)或本地描述符表(LDT)。段描述符是定义段的数据结构，包括段的基址、大小、访问权限和其他属性。门是特殊的描述符，提供对系统段的访问，并用于在特权级别之间切换。

* 1.3 任务状态段和任务门:
  * 任务状态段(TSS)用于存储关于任务当前状态的信息，包括寄存器值、堆栈指针和恢复任务状态所需的其他信息。任务门是提供对任务状态段访问的描述符，用于多任务系统中的任务切换。

* 1.4 中断和异常处理:
  * 中断是由外部设备(如键盘输入或网络接口)产生的异步事件。当中断发生时，处理器停止执行当前程序并跳转到中断处理程序例程来处理中断。异常是由处理器本身生成的同步事件，例如除零或页面错误。处理器停止执行当前程序并跳转到异常处理程序例程来处理异常。

* 1.5 内存管理:
  * 处理器为内存管理提供了几种机制，包括分页和分段。分页是一种内存管理方案，它使用固定大小的页面将虚拟地址映射到物理地址。分段是一种内存管理方案，它将内存划分为不同大小的段，并使用段描述符将逻辑地址映射到物理地址。

* 1.6 系统寄存器:
  * 系统寄存器是处理器用来控制系统各个方面的专用寄存器，例如处理器的当前状态、中断控制器的状态以及当前正在执行的任务。任务寄存器(TR)是一个包含当前任务状态段地址的系统寄存器。控制寄存器(CR)是一个控制各种处理器特性(如分页和虚拟化)的系统寄存器。调试寄存器(DR)是一种用于调试目的的系统寄存器，例如设置断点和监视内存访问。

##### 2. 实模式和保护模式转换

​	实地址模式是处理器使用的一种传统操作模式，它提供了与早期16位处理器的兼容性。在这种模式下，处理器可以直接寻址最多1MB的内存，程序可以使用段寄存器访问内存的不同部分。保护模式是一种较新的操作模式，提供内存保护、虚拟内存和多任务处理功能。在保护模式下，处理器可以使用虚拟地址寻址最多4GB的内存。

 	要从实地址模式转换为保护模式，需要进行一些更改。首先，必须初始化处理器以启用保护模式。这涉及到设置全局和本地描述符表，它们定义内存段及其访问权限。其次，任何在实地址模式下运行的代码都必须重新定位到保护模式代码段。第三，必须更新代码使用的任何数据结构以使用保护模式地址。最后，所有操作系统服务或设备驱动程序都必须更新为在保护模式下工作。
 	
 	若要从保护模式转换回实地址模式，则必须进行相反的更改。必须将处理器重置为禁用保护模式，必须将任何保护模式代码或数据重新定位到实地址模式，并且必须将任何设备驱动程序或服务更新为在实地址模式下工作。

##### 3. 80x86系统指令寄存器

* 3.1标志寄存器(EFLAGS)
  * EFLAGS寄存器是一个32位寄存器，它包含有关处理器的状态信息，例如最后一个算术操作的状态、字符串操作的方向和中断的状态。EFLAGS寄存器中一些常用的标志包括进位标志、零标志、符号标志、溢出标志和方向标志。

* 3.2 全局描述符表寄存器(GDTR)
  * GDTR是用于管理全局描述符表(GDT)的控制寄存器，GDT是在保护模式下用于提供内存保护和分段的数据结构。GDTR是一个48位寄存器，包含GDT的基址和大小。

* 3.3 本地描述符表寄存器(Local Descriptor Table Register, LDTR)
  * LDTR是一个用于管理本地描述符表(Local Descriptor Table, LDT)的控制寄存器，LDT是在保护模式下用于提供内存保护和分段的可选数据结构。LDTR是一个16位寄存器，它包含LDT的段选择器。

* 3.4 中断描述符表寄存器(IDTR)
  * IDTR是用于管理中断描述符表(IDT)的控制寄存器，IDT是用于存储中断处理程序和异常处理程序的数据结构。IDTR是一个48位寄存器，包含IDT的基址和大小。

* 3.5 任务寄存器(TR)
  * TR是一个用于管理任务状态和任务切换机制的控制寄存器。TR是一个16位寄存器，它包含TSS(任务状态段)的段选择器。

* 3.6 控制寄存器(CR0到CR3)
  * CR0到CR3控制寄存器用于控制处理器和系统行为的各个方面，如分页、缓存和保护模式。一些常用的控制寄存器包括CR0(用于启用保护模式和管理系统范围的设置)和CR3(用于管理分页和虚拟内存转换)。CR1和CR2寄存器是保留的，在现代处理器中不使用。

##### 4. 系统指令

* 4.1 LGDT和SGDT:
  * LGDT(加载全局描述符表)使用全局描述符表的基址和限制加载全局描述符表(GDT)寄存器。全局描述符表包含定义处理器使用的内存段的段描述符。LGDT需要一个6字节的内存操作数，其中包含一个16位的限制字段，后面跟着一个32位的基址字段。limit字段指定全局描述符表的大小，base address字段指定表的起始地址。SGDT(存储全局描述符表)在内存中存储全局描述符表寄存器的当前值。SGDT需要一个接收GDT寄存器内容的6字节内存操作数。

* 4.2 LIDT和SIDT:
  * LIDT(加载中断描述符表)用IDT的基址和限制加载中断描述符表寄存器。中断描述符表包含中断和异常门描述符，它们定义了硬件中断和软件异常的处理程序。LIDT需要一个6字节的内存操作数，其中包含一个16位的限制字段，后面跟着一个32位的基址字段。limit字段指定IDT的大小，base address字段指定表的起始地址。SIDT(存储中断描述符表)在内存中存储IDT寄存器的当前值。SIDT需要一个接收IDT寄存器内容的6字节内存操作数。

* 4.3 LLDT和SLDT:
  * LLDT(加载本地描述符表)使用特定进程的LDT的基址和限制加载本地描述符表(LDT)寄存器。LDT包含定义进程使用的内存段的段描述符。LLDT需要一个2字节的内存操作数，其中包含一个指向内存中的LDT的选择器。SLDT(存储本地描述符表)在内存中存储LDT寄存器的当前值。SLDT需要一个2字节的内存操作数，它接收当前LDT的选择器。

* 4.4 LTR和STR:
  * LTR(加载任务寄存器)使用特定任务的任务状态段的选择器加载任务寄存器。任务状态段包含关于任务的信息，例如它的状态、优先级和上下文。LTR需要一个2字节的内存操作数，其中包含一个指向内存中的任务状态段的选择器。STR(存储任务寄存器)在内存中存储任务寄存器的当前值。STR需要一个2字节的内存操作数，接收当前任务状态段的选择器。

这些系统指令用于管理处理器的内存结构和任务管理特性。通过在这些寄存器和表中加载或存储值，软件可以控制系统行为的各个方面，并自定义它管理内存和任务的方式。



